---
output:
  pdf_document: default
  html_document: default
---


```{r}

install.packages(c(
  "tidyverse", "lubridate", "forecast", "tseries",
  "rugarch", "astsa", "lmtest", "zoo", "MASS", "car",
  "Metrics", "GGally", "tinytex", "imputeTS"
))

```




```{r}
library(tidyverse)
library(lubridate) 
library(readr)
library(tidyverse)
library(lubridate)
library(readr)
library(forecast)
library(tseries)
library(dplyr)
library(zoo)
library(MASS)
library(car)
```

```{r}




library(tidyverse)
library(lubridate)
library(zoo)
library(imputeTS)

coco <- read_csv("Daily Prices_ICCO.csv")
colnames(coco) <- tolower(colnames(coco))
coco <- coco %>%
  mutate(date = dmy(date)) %>%
  rename(price = `icco daily price (us$/tonne)`)

climate <- read_csv("Ghana_data.csv") %>%
  rename(
    prcp = PRCP, tavg = TAVG,
    tmin = TMIN, tmax = TMAX,
    date = DATE
  ) %>%
  mutate(date = as.Date(date)) %>%
  arrange(date)

climate_daily_avg <- climate %>%
  group_by(date) %>%
  summarise(across(c(prcp, tavg, tmin, tmax), ~ mean(.x, na.rm = TRUE)))

climate_daily_avg_interp <- climate_daily_avg %>%
  mutate(across(c(prcp, tavg, tmin, tmax), ~ na_interpolation(.x, option = "linear")))

data <- inner_join(coco, climate_daily_avg_interp, by = "date") %>%
  drop_na()

data$date <- as.Date(data$date)

coco <- read_csv("Daily Prices_ICCO.csv") 

colnames(coco) <- tolower(colnames(coco))
coco <- coco %>%
  mutate(date = dmy(date)) %>%
  rename(price = `icco daily price (us$/tonne)`)

climate <- read_csv("Ghana_data.csv")

climate <- climate %>%
  rename(
    prcp = PRCP,
    tavg = TAVG,
    tmin = TMIN,
    tmax = TMAX,
    date = DATE
  ) %>%
  arrange(date)

climate <- climate %>%
  mutate(across(c(prcp, tavg, tmin, tmax), as.numeric)) %>%
  arrange(date)

climate_daily_avg <- climate %>%
  group_by(date) %>%
  summarise(across(c(prcp, tavg, tmin, tmax), mean, na.rm = TRUE))

data <- coco %>%
  inner_join(climate_daily_avg, by = "date") %>%
  drop_na()


data <- data %>% dplyr::select(date,price,tavg, tmin, tmax, prcp)

```

```{r}
library(GGally)

```

```{r}
summary(data)

library(ggplot2)




```

```{r}

# check correlection
cor(dplyr::select(data, price, tavg, tmin, tmax, prcp), use = "complete.obs")

selected_data <- data %>% dplyr::select(price, tavg, tmin, tmax, prcp)

GGally::ggpairs(selected_data)


```

```{r}
# EDA

ggplot(data, aes(x = price)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  labs(title = "Histogram of Daily Cocoa Prices",
       x = "Price (USD/tonne)", y = "Frequency") +
  theme_minimal()




ccf(data$tavg, data$price, lag.max = 30, main = "CCF: tavg vs price")
ccf(data$prcp, data$price, lag.max = 30, main = "CCF: prcp vs price")

data <- data %>%
  mutate(
    tavg_lag4 = lag(tavg, 4),
    prcp_lag7 = lag(prcp, 7)
  ) %>%
  drop_na()

ccf(data$tavg, data$price, na.action = na.omit)


ggplot(data, aes(x = date, y = price)) +
  geom_line(color = "steelblue", size = 0.8) +
  labs(title = "Raw Daily Cocoa Prices (USD/tonne)",
       x = "Date", y = "Price") +
  theme_minimal()

library(zoo)

monthly_data3 <- data %>%
  mutate(month = as.yearmon(date)) %>%
  group_by(month) %>%
  summarise(price = mean(price, na.rm = TRUE))

ggplot(monthly_data3, aes(x = month, y = price)) +
  geom_line(color = "darkgreen", size = 0.9) +
  labs(title = "Monthly Average Cocoa Prices (USD/tonne)",
       x = "Month", y = "Average Price") +
  theme_minimal()


ggplot(data, aes(x = date, y = tavg)) +
  geom_line(color = "darkorange") +
  labs(title = "Daily Average Temperature in Ghana", y = "Â°F", x = "Date") +
  theme_minimal()

ggplot(data, aes(x = date, y = prcp)) +
  geom_line(color = "purple") +
  labs(title = "Daily Precipitation in Ghana", y = "mm", x = "Date") +
  theme_minimal()

# Seasonality & Trends
ts_data <- ts(data$price, frequency = 365)
decomp <- stl(ts_data, s.window = "periodic")
plot(decomp)


```

```{r}
# transformation on price
data <- data %>%
  mutate(log_price = log(price),
         log_diff = c(NA, diff(log_price)),
         return = c(NA, diff(log_price)))

ggplot(data, aes(x = log_price)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  labs(title = "Histogram of Log Daily Cocoa Prices",
       x = "Log of Price (USD/tonne)", y = "Frequency") +
  theme_minimal()

# check stationary
adf.test(na.omit(data$log_diff))
acf(data$log_diff, na.action = na.pass)
pacf(data$log_diff, na.action = na.pass)
plot(data$date, data$log_diff, type = "l", col = "blue",
     main = "Differenced Log of Cocoa Prices")


```

```{r}
# var selection

data2 <- data %>%
  mutate(
    tavg_lag3 = lag(tavg, 3),
    prcp_lag7 = lag(prcp, 7)
  ) %>%
  drop_na()

model_full <- lm(log_price ~ tavg + prcp + tavg_lag3 + prcp_lag7 + tmin + tmax
                 , data = data2)

summary(model_full)

model_step <- stepAIC(model_full, direction = "both")
summary(model_step)

vif(model_step)

```

```{r}
# remove tmin
model1 <- lm(log_price ~ tavg + prcp + tavg_lag3 + prcp_lag7 + tmax
                 , data = data2)
vif(model1)
summary(model1)

```

```{r}
#ARIMA modeling

# Convert to monthly time series using mean of log-prices
monthly_data <- data2 %>%
  mutate(month = as.yearmon(date)) %>%
  group_by(month) %>%
  summarise(price = mean(price, na.rm = TRUE)) %>%
  mutate(log_price = log(price))

# Convert to time series
log_price_ts <- ts(monthly_data$log_price, frequency = 12, start = c(year(min(monthly_data$month)), month(min(monthly_data$month))))

ggplot(data = monthly_data, aes(x = month, y = price)) +
  geom_line(color = "steelblue") +
  labs(title = "Monthly Cocoa Prices", x = "Month", y = "Price (USD/tonne)")

# ACF and PACF for log_price
acf(data$log_price, main = "ACF of Log Cocoa Price")
pacf(data$log_price, main = "PACF of Log Cocoa Price")

# Stationarity
adf.test(log_price_ts)

# Fit ARIMA 
arima_model <- auto.arima(log_price_ts)
summary(arima_model)

#  Residual Diagnostics
checkresiduals(arima_model)

# Forecast 12 months 
forecast_arima <- forecast(arima_model, h = 12)
autoplot(forecast_arima) + 
  labs(title = "Forecasted Log Cocoa Prices (ARIMA)", y = "log(Price)", x = "Time")

#  Back-transform forecast to original scale
forecast_arima_exp <- exp(forecast_arima$mean)

# Plot
forecast_df <- data.frame(
  Month = seq(max(monthly_data$month) + 1/12, by = 1/12, length.out = 12),
  ARIMA_Forecast = as.numeric(forecast_arima_exp)
)

fitted_arima <- fitted(arima_model)
actual_arima <- log_price_ts

# Plot
plot.ts(cbind(actual = actual_arima, fitted = fitted_arima), 
        plot.type = "single", col = c("black", "blue"), 
        main = "ARIMA: Actual vs Fitted (Log Prices)", ylab = "Log Price")
legend("topright", legend = c("Actual", "Fitted"), col = c("black", "blue"), lty = 1)

ggplot() +
  geom_line(data = monthly_data, aes(x = month, y = price), color = "steelblue") +
  geom_line(data = forecast_df, aes(x = Month, y = ARIMA_Forecast), color = "red", size = 1.2) +
  labs(title = "Cocoa Price Forecast (Monthly, ARIMA)",
       x = "Month", y = "Price (USD/tonne)") +
  theme_minimal()

ggtsdisplay(diff(log_price_ts), main = "Differenced Monthly Log Prices")

Box.test(residuals(arima_model), lag = 12, type = "Ljung-Box")

autoplot(forecast_arima) +
  labs(title = "Forecasted Log Cocoa Prices (ARIMA)", y = "log(Price)", x = "Time") +
  autolayer(fitted(arima_model), series = "Fitted")





arima_resid <- residuals(arima_model)

# Histogram
hist(arima_resid, breaks = 50, col = "steelblue", main = "Histogram of ARIMA Residuals", xlab = "Residuals")

#QQ
qqnorm(arima_resid, main = "QQ Plot of ARIMA Residuals")
qqline(arima_resid, col = "red", lwd = 2)




```

```{r}

log_ret <- diff(log(data$price))
log_ret <- na.omit(log_ret)

library(rugarch)
spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1,1)),
  mean.model = list(armaOrder = c(2,2)),
  distribution.model = "std"
)
fit <- ugarchfit(spec = spec, data = log_ret)

forecast_garch <- ugarchforecast(fit, n.ahead = 30)
volatility <- sigma(forecast_garch)

last_price <- tail(data$price, 1)
upper <- last_price * exp(volatility * 1.96)
lower <- last_price * exp(-volatility * 1.96)



library(rugarch)

log_price_ts <- ts(na.omit(data$log_price), frequency = 365)
log_diff <- na.omit(diff(log_price_ts))


garch_spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1,1)),
  mean.model = list(armaOrder = c(2,2), include.mean = TRUE),
  distribution.model = "std"
)


garch_fit <- ugarchfit(spec = garch_spec, data = log_diff)
show(garch_fit)


garch_resid <- residuals(garch_fit)
acf(garch_resid^2, main = "ACF of Squared GARCH Residuals")


garch_forecast <- ugarchforecast(garch_fit, n.ahead = 30)
vol_forecast <- sigma(garch_forecast)


plot(vol_forecast, type = "l", col = "darkred", lwd = 2,
     main = "Forecasted Volatility from GARCH(1,1)",
     ylab = "Volatility", xlab = "Days Ahead")



```

```{r}


library(zoo)
monthly_data2 <- data %>%
  mutate(month = as.yearmon(date)) %>%
  group_by(month) %>%
  summarise(
    price = mean(price, na.rm = TRUE),
    tavg = mean(tavg, na.rm = TRUE),
    prcp = mean(prcp, na.rm = TRUE),
    tavg_lag4 = mean(tavg_lag4, na.rm = TRUE),
    prcp_lag7 = mean(prcp_lag7, na.rm = TRUE),
    tmax = mean(tmax, na.rm = TRUE)
  ) %>%
  mutate(log_price = log(price)) %>%
  drop_na()

log_price_ts <- ts(monthly_data2$log_price, frequency = 12,
                   start = c(year(min(monthly_data2$month)), month(min(monthly_data2$month))))

xreg_matrix <- as.matrix(monthly_data2 %>%
                           dplyr::select(tavg, prcp, tavg_lag4, prcp_lag7, tmax))

library(forecast)
arimax_model <- auto.arima(log_price_ts, xreg = xreg_matrix)

future_xreg <- matrix(rep(colMeans(tail(xreg_matrix, 12)), 12), nrow = 12, byrow = TRUE)

arimax_forecast <- forecast(arimax_model, xreg = future_xreg, h = 12)
arimax_pred <- exp(arimax_forecast$mean)



monthly_climate <- data2 %>%
  mutate(month = as.yearmon(date)) %>%
  group_by(month) %>%
  summarise(across(c(tavg, prcp,tavg_lag3, prcp_lag7,tmax)))


monthly_data2 <- data2 %>%
  mutate(month = as.yearmon(date)) %>%
  group_by(month) %>%
  summarise(price = mean(price, na.rm = TRUE)) %>%
  mutate(log_price = log(price)) %>%
  inner_join(monthly_climate, by = "month") %>%
  drop_na()


log_price_ts <- ts(monthly_data2$log_price, frequency = 12,
                   start = c(year(min(monthly_data2$month)), month(min(monthly_data2$month))))


xreg_matrix <- as.matrix(monthly_data2 %>% dplyr::select(tavg,prcp,tavg_lag3, prcp_lag7,tmax))


arimax_model <- auto.arima(log_price_ts, xreg = xreg_matrix)
summary(arimax_model)


future_xreg <- tail(xreg_matrix, 12)

arimax_forecast <- forecast(arimax_model, xreg = future_xreg, h = 12)
arimax_pred <- exp(arimax_forecast$mean)

forecast_df$ARIMAX <- as.numeric(arimax_pred)




fitted_arimax <- fitted(model1)
actual_arimax <- monthly_data2$log_price

# Plot
plot.ts(cbind(actual = actual_arimax, fitted = fitted_arimax), 
        plot.type = "single", col = c("black", "green"),
        main = "ARIMAX: Actual vs Fitted (Log Prices)", ylab = "Log Price")
legend("topright", legend = c("Actual", "Fitted"), col = c("black", "green"), lty = 1)



# Residuals 
arimax_resid <- residuals(model1)

# Histogram
hist(arimax_resid, breaks = 50, col = "darkgreen", main = "Histogram of ARIMAX Residuals", xlab = "Residuals")

# QQ Plot
qqnorm(arimax_resid, main = "QQ Plot of ARIMAX Residuals")
qqline(arimax_resid, col = "red", lwd = 2)



```

```{r}
# comparison


actual <- tail(monthly_data$price, 12)


pred_arima <- tail(as.numeric(forecast_arima_exp), 12)
pred_arimax <- tail(as.numeric(arimax_pred), 12)

library(Metrics)

# RMSE and MAE
arima_rmse <- rmse(actual, pred_arima)
arima_mae  <- mae(actual, pred_arima)

arimax_rmse <- rmse(actual, pred_arimax)
arimax_mae  <- mae(actual, pred_arimax)

# AIC
arima_aic <- arima_model$aic
arimax_aic <- arimax_model$aic


model_comparison <- data.frame(
  Model = c("ARIMA(0,1,1)", "ARIMAX (climate variables)"),
  RMSE = c(round(arima_rmse, 4), round(arimax_rmse, 4)),
  MAE  = c(round(arima_mae, 4), round(arimax_mae, 4)),
  AIC  = c(round(arima_aic, 2), round(arimax_aic, 2))
)

model_comparison

# Extract parameters
garch_params <- coef(garch_fit)
omega <- garch_params["omega"]
alpha1 <- garch_params["alpha1"]
beta1 <- garch_params["beta1"]
vol_persistence <- alpha1 + beta1
vol_persistence


```
